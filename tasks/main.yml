---

- name: Copy custom configuration files to the client
  synchronize:
    src: "./etc/"
    dest: "/etc"
    recursive: yes
    links: yes
    # set_remote_user: no
  when: linuxmuster_net_client_customize_copy_custom_config_etc

- name: Copy custom configuration files to the client and delete all other files
  synchronize:
    src: ".{{ item }}/"
    dest: "{{ item }}"
    recursive: yes
    links: yes
    delete: yes
    set_remote_user: no
  when: item is defined and item
  with_flattened:
    - linuxmuster_net_client_customize_etc_delete_sync

## Remove when https://github.com/linuxmuster/linuxmuster-client-extras/pull/3 is merged.
## Donâ€˜t. I adopted the script.
- name: Make sure the fixed shutdown script is available
  copy:
    src: "check-shutdown"
    dest: "/usr/bin/check-shutdown"
    mode: "0755"
    owner: root
    group: root

- name: Create auto shutdown cron job
  template:
    src: "cron.auto_shutdown.j2"
    dest: "/etc/cron.d/auto-shutdown"
    mode: "0644"
    owner: root
    group: root

- name: Create local scripts script
  template:
    src: "{{ item.file }}.j2"
    dest: "/usr/local/bin/{{ item.file }}"
    mode: "{{ item.mode | default('0744') }}"
    ## Makes no sense to run as normal user.
    validate: '{{ item.validate | default(omit) }}'
    owner: root
    group: root
  when: ((item.when is defined and item.when != 'False') or item.when is not defined)
  with_items:
    - file: "sync_localuser"
      when: "{{ linuxmuster_net_client_customize_local_user_enable }}"
    - file: "make_clean_for_image"

- name: Enable sync_localuser script
  lineinfile:
    dest: '/etc/rc.local'
    regexp: "^{{ linuxmuster_net_client_customize_local_user_script_filepath }}"
    line: "{{ linuxmuster_net_client_customize_local_user_script_filepath }} 1> /var/log/sync_localuser.log"
    insertbefore: '^exit 0'
  when: linuxmuster_net_client_customize_local_user_enable

- name: Disable sync_localuser script
  lineinfile:
    dest: '/etc/rc.local'
    line: "{{ linuxmuster_net_client_customize_local_user_script_filepath }}"
    state: absent
  when: not linuxmuster_net_client_customize_local_user_enable

- name: Include OS specific variables
  include_vars: "ypid_packages.yml"
  when: linuxmuster_net_client_apt_packages is not iterable

## Did not work on Ubuntu?
- name: Install all packages
  apt:
    name: "{{ item }}"
    state: 'latest'
  when: item is defined and item
  with_flattened:
    - linuxmuster_net_client_apt_packages
    - linuxmuster_net_client_apt_packages_group
    - linuxmuster_net_client_apt_packages_host
  tags: package_install
